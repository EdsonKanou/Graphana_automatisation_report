Bonjour ! Je comprends votre situation. Vous avez raison : l'API `/api/ds/query` n'existe pas dans toutes les versions de Grafana ou n√©cessite une approche sp√©cifique.

Voici **plusieurs alternatives** pour r√©cup√©rer les valeurs r√©elles de votre dashboard :

## üìä Solutions recommand√©es

### **1. API Query Datasource (recommand√©e pour Grafana 12.x)**

Pour Grafana 12.1.0, utilisez l'endpoint `/api/datasources/proxy/{id}/query` :

```bash
curl -k -X POST \
  -H "Authorization: Bearer <API_KEY>" \
  -H "Content-Type: application/json" \
  https://<ton-grafana>/api/datasources/proxy/4/query \
  -d '{
    "queries": [
      {
        "refId": "A",
        "format": "table",
        "rawSql": "SELECT * FROM ma_table LIMIT 10",
        "datasourceId": 4
      }
    ]
  }'
```

### **2. API Dashboard + Reconstruction de la requ√™te**

R√©cup√©rez d'abord la d√©finition du panel, puis ex√©cutez la requ√™te :

**√âtape 1** - R√©cup√©rer le dashboard complet :
```bash
curl -k -H "Authorization: Bearer <API_KEY>" \
  https://<ton-grafana>/api/dashboards/uid/<DASHBOARD_UID>
```

**√âtape 2** - Extraire la requ√™te SQL du panel :
```json
{
  "panels": [{
    "targets": [{
      "rawSql": "SELECT time, value FROM metrics WHERE ...",
      "datasource": {"uid": "cebe2fax1rieob"}
    }]
  }]
}
```

**√âtape 3** - Ex√©cuter la requ√™te directement contre PostgreSQL :
```bash
# Option A : Via l'API Grafana datasource proxy
curl -k -X POST \
  -H "Authorization: Bearer <API_KEY>" \
  -H "Content-Type: application/json" \
  https://<ton-grafana>/api/datasources/proxy/4/query \
  -d '{"rawSql": "VOTRE_REQUETE_ICI"}'

# Option B : Directement sur PostgreSQL (si acc√®s possible)
psql -h <postgres-host> -U <user> -d <database> -c "VOTRE_REQUETE_ICI"
```

### **3. API Annotations (si applicable)**

Si votre panel utilise des annotations :
```bash
curl -k -H "Authorization: Bearer <API_KEY>" \
  "https://<ton-grafana>/api/annotations?dashboardId=<ID>&from=<timestamp>&to=<timestamp>"
```

### **4. Export via API Rendering (capture d'√©cran + OCR)**

Solution de dernier recours - exporter le panel en image :
```bash
curl -k -H "Authorization: Bearer <API_KEY>" \
  "https://<ton-grafana>/render/d-solo/<DASHBOARD_UID>/<PANEL_ID>?orgId=1&from=now-6h&to=now&width=1000&height=500" \
  -o panel.png
```

## üîç Informations dont j'ai besoin pour vous aider davantage :

1. **UID du dashboard** : Pour r√©cup√©rer sa d√©finition compl√®te
2. **ID du panel** : Le num√©ro du panel sp√©cifique qui vous int√©resse
3. **Type de visualisation** : Graph, Table, Stat, Gauge, etc. ?
4. **Exemple de requ√™te SQL** du panel (si vous l'avez sous les yeux dans l'interface Grafana)
5. **Acc√®s direct √† PostgreSQL** : Pouvez-vous vous connecter directement √† la base de donn√©es PostgreSQL ?

## ‚úÖ Prochaine √©tape recommand√©e

Essayez d'abord l'**option 2** (r√©cup√©rer le dashboard puis ex√©cuter la requ√™te), car c'est la plus fiable :

```bash
# 1. R√©cup√©rer le dashboard
curl -k -H "Authorization: Bearer <API_KEY>" \
  https://<ton-grafana>/api/dashboards/uid/<DASHBOARD_UID> | jq '.'

# 2. Cherchez dans la sortie JSON la section "targets" de votre panel
# 3. Copiez la requ√™te SQL
# 4. Ex√©cutez-la via le proxy datasource ou directement sur PostgreSQL
```

Dites-moi quel dashboard/panel vous cible et je vous aide √† construire la requ√™te exacte ! üöÄ










Je vois les probl√®mes ! Analysons les deux tentatives :

## üî¥ Probl√®mes identifi√©s

### **Option A - Erreur 502 Bad Gateway**
- **Erreur HTTP 502** : Le proxy Grafana ne peut pas atteindre PostgreSQL ou la requ√™te est mal format√©e
- **JSON invalide** : `'["rawSql": "SELECT 1 "]'` n'est pas un JSON valide (crochets au lieu d'accolades)

### **Option B - Export image : ‚úÖ Succ√®s !**
Votre export d'image a fonctionn√© (9095 bytes t√©l√©charg√©s) ! Le fichier `panel.png` devrait contenir une capture du panel.

## üõ†Ô∏è Solutions corrig√©es

### **Solution 1 : Corriger l'appel API datasource proxy**

```bash
# Correction du JSON (accolades au lieu de crochets)
curl -v -k -X POST \
  -H "Authorization: Bearer " \
  -H "Content-Type: application/json" \
  https://orchestrator-dashboard.group.echonet/api/datasources/proxy/4/query \
  -d '{
    "queries": [{
      "refId": "A",
      "rawSql": "SELECT 1 AS test",
      "format": "table",
      "datasourceId": 4
    }]
  }'
```

### **Solution 2 : Tester la connectivit√© PostgreSQL via Grafana**

```bash
# Test simple de connexion
curl -v -k -X GET \
  -H "Authorization: Bearer " \
  https://orchestrator-dashboard.group.echonet/api/datasources/4
```

### **Solution 3 : R√©cup√©rer la requ√™te du panel puis l'ex√©cuter**

**√âtape 1** - R√©cup√©rer le dashboard (remplacez `debe5b0zgerr4b` par votre UID) :
```bash
curl -k -H "Authorization: Bearer " \
  https://orchestrator-dashboard.group.echonet/api/dashboards/uid/debe5b0zgerr4b \
  | jq '.dashboard.panels[] | select(.id==12) | .targets' > panel_12_query.json
```

**√âtape 2** - Examiner la requ√™te extraite :
```bash
cat panel_12_query.json
```

**√âtape 3** - Utiliser la vraie requ√™te SQL du panel :
```bash
# Remplacez VOTRE_REQUETE_SQL par celle trouv√©e dans panel_12_query.json
curl -v -k -X POST \
  -H "Authorization: Bearer " \
  -H "Content-Type: application/json" \
  https://orchestrator-dashboard.group.echonet/api/datasources/proxy/4/query \
  -d '{
    "queries": [{
      "refId": "A",
      "rawSql": "VOTRE_REQUETE_SQL_ICI",
      "format": "table"
    }]
  }'
```

### **Solution 4 : Alternative - API Query directe (Grafana 12.x)**

```bash
curl -v -k -X POST \
  -H "Authorization: Bearer " \
  -H "Content-Type: application/json" \
  https://orchestrator-dashboard.group.echonet/api/ds/query \
  -d '{
    "queries": [{
      "refId": "A",
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "cebe2fax1rieob"
      },
      "rawSql": "SELECT 1 AS test",
      "format": "table"
    }],
    "from": "now-1h",
    "to": "now"
  }'
```

## üéØ Plan d'action recommand√©

1. **D'abord**, r√©cup√©rez la d√©finition compl√®te du panel 12 :
```bash
curl -k -H "Authorization: Bearer xxxx" \
  https://orchestrator-dashboard.group.echonet/api/dashboards/uid/debe5b0zgerr4b \
  | jq '.dashboard.panels[] | select(.id==12)'
```

2. **Envoyez-moi** le r√©sultat JSON, je pourrai alors :
   - Extraire la requ√™te SQL exacte
   - Construire l'appel API correct avec les bons param√®tres
   - Identifier pourquoi le proxy retourne 502

3. **Si l'erreur 502 persiste**, deux causes possibles :
   - PostgreSQL n'est pas accessible depuis Grafana
   - La configuration du datasource a un probl√®me

**Pouvez-vous me partager le r√©sultat de cette commande ?**
```bash
curl -k -H "Authorization: Bearer xxx" \
  https://orchestrator-dashboard.group.echonet/api/dashboards/uid/debe5b0zgerr4b \
  | jq '.dashboard.panels[] | select(.id==12)'
```

Cela me permettra de vous donner la solution exacte ! üöÄ